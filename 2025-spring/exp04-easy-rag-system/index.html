<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç–— RAG ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f7f9;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; text-align: center; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input {
            flex-grow: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        button {
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #loading { display: none; color: #7f8c8d; text-align: center; margin: 20px 0; }
        #result { margin-top: 30px; }
        .answer-box {
            background-color: #e8f6fe;
            padding: 20px;
            border-left: 5px solid #3498db;
            border-radius: 4px;
            line-height: 1.6;
            margin-bottom: 5px;
            white-space: pre-wrap; /* ä¿ç•™ç”Ÿæˆå›ç­”ä¸­çš„æ¢è¡Œ */
            word-break: break-all;
        }
        .stats-bar {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 20px;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            gap: 15px;
        }
        .context-item {
            background-color: #f9f9f9;
            padding: 15px;
            border: 1px solid #eee;
            margin-bottom: 10px;
            border-radius: 4px;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œç¬¦ */
            font-size: 14px;
            line-height: 1.5;
            color: #34495e;
        }
        .context-title { 
            font-weight: bold; 
            color: #2c3e50; 
            margin-bottom: 8px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 5px; 
            display: block;
            word-break: break-all; /* å…è®¸æ ‡é¢˜é•¿æ–‡æœ¬æ¢è¡Œ */
        }
        .context-content {
            word-break: break-all;
            overflow-wrap: break-word;
        }
        #contextArea {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .status-ready { background-color: #2ecc71; color: white; }
        .status-loading { background-color: #f1c40f; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“„ åŒ»ç–— RAG ç³»ç»Ÿ</h1>
        <div style="text-align: center;">
            <span id="status" class="status-badge status-loading">æ­£åœ¨è¿æ¥åç«¯æ£€ç´¢æœåŠ¡... </span>
        </div>

        <div class="input-group">
            <input type="text" id="queryInput" placeholder="è¯·è¾“å…¥æ‚¨çš„åŒ»ç–—ç›¸å…³é—®é¢˜..." onkeypress="if(event.keyCode==13) sendQuery()">
            <button id="sendBtn" onclick="sendQuery()">æé—®</button>
        </div>

        <div id="loading">æ­£åœ¨æ£€ç´¢å¹¶ç”Ÿæˆå›ç­”ï¼Œè¯·ç¨å€™...</div>

        <div id="result">
            <div id="answerArea"></div>
            <div id="contextArea"></div>
        </div>
    </div>

    <script>
        async function checkStatus() {
            const badge = document.getElementById('status');
            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: "ping"})
                });
                if (response.ok) {
                    const data = await response.json();
                    const docCount = data.stats ? data.stats.doc_count : 0;
                    badge.innerText = `ç³»ç»Ÿå°±ç»ª (å·²åŠ è½½ ${docCount} æ¡åŒ»å­¦æ•°æ®)`;
                    badge.className = "status-badge status-ready";
                }
            } catch (e) {
                badge.innerText = "æ­£åœ¨ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... (æ­£åœ¨åŠ è½½æ£€ç´¢ç´¢å¼•)";
                badge.className = "status-badge status-loading";
            }
        }

        setInterval(checkStatus, 2000);

        async function sendQuery() {
            const query = document.getElementById('queryInput').value;
            if (!query) return;

            const btn = document.getElementById('sendBtn');
            const loading = document.getElementById('loading');
            const answerArea = document.getElementById('answerArea');
            const contextArea = document.getElementById('contextArea');

            btn.disabled = true;
            loading.style.display = 'block';
            answerArea.innerHTML = `
                <div id="statsBar" class="stats-bar" style="display:none; border: 1px solid #3498db; background: #e8f6fe; color: #2980b9; font-weight: bold;">
                    <span>Tokens: <span id="tokenCount">0</span></span>
                    <span>é€Ÿåº¦: <span id="speed">0</span> tokens/s</span>
                    <span>è€—æ—¶: <span id="elapsed">0</span>s</span>
                </div>
                <h3>ç”Ÿæˆçš„å›ç­”:</h3>
                <div id="streamingAnswer" class="answer-box"></div>
            `;
            contextArea.innerHTML = '';
            
            const streamingAnswer = document.getElementById('streamingAnswer');
            const statsBar = document.getElementById('statsBar');
            const tokenCountSpan = document.getElementById('tokenCount');
            const speedSpan = document.getElementById('speed');
            const elapsedSpan = document.getElementById('elapsed');
            let fullAnswer = "";

            try {
                const response = await fetch('/query/stream', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query})
                });

                if (response.status === 503) {
                    alert("ç³»ç»Ÿä»åœ¨åŠ è½½æ¨¡å‹ä¸­ï¼Œè¯·ç¨åå†è¯•ã€‚");
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = "";
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    let lines = buffer.split('\n');
                    
                    // æœ€åä¸€ä¸ªå…ƒç´ å¯èƒ½æ˜¯å®Œæ•´è¡Œï¼Œä¹Ÿå¯èƒ½æ˜¯æ®‹ç¼ºè¡Œ
                    // å¦‚æœ buffer ä»¥ \n ç»“å°¾ï¼Œåˆ™ lines æœ€åä¸€ä¸ªå…ƒç´ æ˜¯ç©ºå­—ç¬¦ä¸²
                    // å¦‚æœ buffer ä¸ä»¥ \n ç»“å°¾ï¼Œåˆ™ lines æœ€åä¸€ä¸ªå…ƒç´ æ˜¯æ®‹ç¼ºè¡Œï¼Œéœ€è¦ç•™ç»™ä¸‹ä¸€æ¬¡å¤„ç†
                    buffer = lines.pop(); 
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const data = JSON.parse(line);
                            
                            if (data.context) {
                                // å¤„ç†ä¸Šä¸‹æ–‡
                                let contextHtml = '<h3>å‚è€ƒä¸Šä¸‹æ–‡:</h3>';
                                data.context.forEach((doc, i) => {
                                    contextHtml += `
                                        <div class="context-item">
                                            <div class="context-title">æ–‡æ¡£ ${i+1}: ${doc.title}</div>
                                            <div class="context-content">${doc.content || 'æ— å†…å®¹'}</div>
                                        </div>
                                    `;
                                });
                                contextArea.innerHTML = contextHtml;
                                loading.style.display = 'none'; // æ”¶åˆ°ä¸Šä¸‹æ–‡åå°±å¯ä»¥éšè—åŠ è½½æç¤ºäº†
                            } else if (data.answer_chunk) {
                                // å¤„ç†å›ç­”ç‰‡æ®µ
                                fullAnswer += data.answer_chunk;
                                streamingAnswer.innerText = fullAnswer;
                                
                                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                                if (data.token_count !== undefined) {
                                    statsBar.style.display = 'flex';
                                    tokenCountSpan.innerText = data.token_count;
                                    speedSpan.innerText = data.speed;
                                    elapsedSpan.innerText = data.elapsed;
                                }
                            } else if (data.error) {
                                streamingAnswer.innerHTML = `<span style="color: red;">${data.error}</span>`;
                            }
                        } catch (e) {
                            console.error("è§£ææµæ•°æ®å¤±è´¥:", e, line);
                        }
                    }
                }

            } catch (error) {
                console.error("è¯·æ±‚å¤±è´¥:", error);
                alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡å™¨æ˜¯å¦è¿è¡Œæ­£å¸¸ã€‚");
            } finally {
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
